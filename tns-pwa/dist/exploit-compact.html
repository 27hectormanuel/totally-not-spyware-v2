<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Incompatible Spyware Now Compatible</title>
    
    <!-- PWA Properties -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="TotallyNotSpyware v2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <!-- Preferred local icons (iOS uses these for A2HS); remote kept as fallback -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="../../icons/icon-167x167.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../icons/icon-120x120.png">
    <link rel="apple-touch-icon" href="https://totally.not.spyware.lol/img/ios-icon.png">
    <link rel="manifest" href="../../manifest.json">
    
    <!-- iOS 12 Compatible Styling -->
    <style>
        /* Base page reset (no forced dark background) */
        html, body {
            background: transparent;
            color: inherit;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden; /* allow normal vertical scroll within side menu */
            touch-action: manipulation; /* disable double-tap zoom, allow basic taps */
            overscroll-behavior-y: none;
        }
        
        /* Loading state */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            margin-top: 20px;
            color: #ff6b6b;
            font-size: 18px;
        }
        
        /* Error state */
        .error-state {
            display: none;
            text-align: center;
            padding: 50px 20px;
            background: #000;
            color: #fff;
            min-height: 100vh;
        }
        
        .error-state.visible {
            display: block;
        }
        
        .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .retry-button {
            background: #ff6b6b;
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .retry-button:hover {
            background: #ff5252;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: transparent; /* themes provide background */
            height: 100vh;
            display: block;
            overflow-x: hidden;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            position: fixed; /* lock page scroll */
            inset: 0;
        }
        
        .block {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        header {
            text-align: center;
            position: relative;
        }
        /* Larger banner */
        header.block { padding: 24px 18px; }
        .time { font-size: clamp(36px, 6vw, 64px); font-weight: 800; letter-spacing: 0.03em; }
        .date { font-size: clamp(18px, 3.2vw, 28px); margin-top: 6px; }
        
        /* Floating Hamburger: small, translucent, accessible */
        .hamburger {
            position: fixed;
            right: 16px;
            bottom: calc(16px + env(safe-area-inset-bottom));
            width: 48px;
            height: 48px;
            border-radius: 24px;
            background: rgba(0,0,0,0.35);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: transform 0.15s ease;
        }
        .hamburger:hover { transform: scale(1.03); }
        .hamburger:active { transform: scale(0.98); }
        .hamburger:focus-visible { outline: 2px solid #ffffffaa; outline-offset: 3px; }
        .hamburger .gear { font-size: 22px; line-height: 1; color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.6); }
        .hamburger.dragging { cursor: grabbing; }
        
        /* Theme Menu */
        .theme-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 340px;
            height: 100vh;
            background: var(--menu-bg, rgba(0, 0, 0, 0.92));
            -webkit-backdrop-filter: var(--menu-blur, blur(10px));
            backdrop-filter: var(--menu-blur, blur(10px));
            border-left: 1px solid var(--menu-border, rgba(255, 255, 255, 0.15));
            transition: right 0.28s ease;
            z-index: 1000;
            padding: 80px 20px 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y !important;
            overscroll-behavior-y: contain;
            color: var(--menu-fg, #fff);
            font-weight: 700;
            background-clip: padding-box;
            will-change: backdrop-filter, right;
        }
        .status-row { display:flex; align-items:center; gap:8px; margin: 8px 0 6px; }
        .status-badge { display:inline-block; padding: 4px 8px; border-radius: 999px; font-weight: 800; font-size: 12px; }
        .status-live { background: rgba(16,185,129,.18); border:1px solid rgba(16,185,129,.45); color:#34d399; }
        .status-cached { background: rgba(99,102,241,.18); border:1px solid rgba(99,102,241,.45); color:#a5b4fc; }
        .status-unknown { background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2); color:#fff; opacity:.85; }
        /* Activity log inside logo menu */
        .activity-log {
            margin-top: 12px;
            padding: 10px;
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 10px;
            height: 180px;
            overflow-y: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 12px;
            line-height: 1.4;
            color: var(--menu-fg, #fff);
        }
        .activity-log .log-title { font-weight: 800; margin-bottom: 6px; opacity: .9; }
        
        .theme-menu.active {
            right: 0;
        }
        
        .theme-menu h3 {
            color: var(--menu-title, #ff6b6b);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .theme-option {
            background: var(--opt-bg, rgba(255, 255, 255, 0.1));
            border: 1px solid var(--opt-border, rgba(255, 255, 255, 0.2));
            border-radius: 16px;
            padding: 18px 16px;
            margin: 10px 0;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            -webkit-user-select: none;
            user-select: none;
            box-shadow: 0 8px 18px rgba(0,0,0,0.08), inset 0 0 0 1px rgba(255,255,255,0.3);
        }
        
        .theme-option:hover {
            background: var(--opt-hover-bg, rgba(255, 255, 255, 0.2));
        }
        
        .theme-option.active {
            background: transparent;
            border-color: #7BA58F;
        }

        /* Drag & drop UI */
        .drag-handle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 900;
            color: var(--handle-fg, #ffffffcc);
            cursor: grab;
        }
        .dragging-item { opacity: 0.8; transform: scale(0.98); cursor: grabbing; }
        .drag-placeholder { height: 62px; border: 2px dashed #ffffff55; border-radius: 16px; margin: 12px 0; }
        .dragging-hidden { visibility: hidden; position: absolute; left: -9999px; top: -9999px; width: 0; height: 0; pointer-events: none; }
        .drag-ghost {
            position: fixed;
            left: 0;
            top: 0;
            transform: translate3d(0,0,0);
            pointer-events: none;
            z-index: 2000;
            opacity: 0.95;
            box-shadow: 0 12px 24px rgba(0,0,0,0.25);
        }

        /* Light theme sidebar overrides: hide black when not in deep-dark themes */
        body.theme-chimera.chimera-light .theme-menu,
        body.theme-chimera.chimera-green .theme-menu,
        body.theme-modern .theme-menu,
        body.theme-classic .theme-menu,
        body.theme-cyber .theme-menu,
        body.theme-neon .theme-menu,
        body.theme-vapor .theme-menu {
            /* Tiny alpha makes Chromium render blur while visually transparent */
            --menu-bg: rgba(255,255,255,0.02);
            --menu-fg: var(--chimera-accent, #3cc1b2);
            --menu-title: var(--chimera-accent, #3cc1b2);
            --menu-border: rgba(0,0,0,0.06);
            --opt-bg: #ffffff;
            --opt-hover-bg: #f6f8fa;
            --opt-border: rgba(0,0,0,0.06);
            --opt-active-bg: rgba(255,107,107,0.18);
            --handle-fg: #333;
            --menu-blur: blur(10px);
            width: 280px;
        }

        /* Chimera subtheme UI */
        .subthemes { display: none; padding-left: 8px; }
        .subthemes.open { display: block; }
        .subtheme-option { border-radius: 12px; padding: 14px 14px; }
        .chimera-toggle { font-size: 12px; color: var(--menu-fg, #fff); opacity: .85; }
        .chimera-toggle .toggle-row { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .chimera-toggle .icon-sun, .chimera-toggle .icon-moon { font-size: 14px; opacity: 0.65; color: rgba(0,0,0,0.45); }
        .chimera-toggle .more-link { margin-left: auto; background: none; border: none; color: inherit; font-weight: 700; cursor: pointer; padding: 6px 8px; border-radius: 8px; }
        .chimera-toggle .more-link:active { transform: scale(0.98); }
        .switch { position: relative; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .switch .slider { position: absolute; inset: 0; cursor: pointer; background: color-mix(in srgb, var(--chimera-accent, #3cc1b2) 35%, #dff7f2); border-radius: 999px; transition: background 0.2s ease; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08); }
        .switch .slider:before { content: ""; position: absolute; height: 20px; width: 20px; left: 2px; top: 2px; background: #fff; border-radius: 50%; transition: transform 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .switch input:checked + .slider { background: color-mix(in srgb, #0f172a 85%, var(--chimera-accent, #3cc1b2)); }
        .switch input:checked + .slider:before { transform: translateX(22px); }

        /* Accent-aware icon highlights to fit Chimera look */
        body.theme-chimera:not(.chimera-dark) .chimera-toggle .icon-sun { opacity: 1; color: var(--chimera-accent, #3cc1b2); }
        body.theme-chimera:not(.chimera-dark) .chimera-toggle .icon-moon { opacity: .35; }
        body.theme-chimera.chimera-dark .chimera-toggle .icon-moon { opacity: 1; color: var(--chimera-accent, #3cc1b2); }
        body.theme-chimera.chimera-dark .chimera-toggle .icon-sun { opacity: .35; }
        
        .time {
            font-size: 3rem;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .colon {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .date {
            font-size: 1.2rem;
            color: #74b9ff;
            margin-top: 10px;
        }
        
        #main {
            text-align: center;
            padding: 50px 20px;
            position: relative;
        }
        
        /* Logo group sits between header and slider; JS adjusts its top and size */
        #logo-group { position: absolute; left: 50%; transform: translateX(-50%); top: 50%; z-index: 5; }
        :root { --logo-size: clamp(160px, 46vw, 260px); --backdrop-size: calc(var(--logo-size) + 40px); }
        #logo-wrap {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: var(--logo-size);
            height: var(--logo-size);
            margin: 0 auto;
            border-radius: 50%;
            display: inline-block;
            z-index: 1;
        }
        #logo {
            width: 100%;
            height: 100%;
            animation: spin 3s linear infinite;
            cursor: pointer;
            border-radius: 50%;
            background: transparent;
            object-fit: cover;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        /* Backdrop behind the spinning logo for contrast */
        #logo-backdrop {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: var(--backdrop-size);
            height: var(--backdrop-size);
            border-radius: 32px;
            background: var(--card-bg, linear-gradient(135deg, #e9fbff 0%, #f5ecf2 100%));
            box-shadow: 0 16px 48px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.55);
            pointer-events: none;
            z-index: 0;
        }
        /* keep the logo above backdrop and label */
        #logo { position: absolute; z-index: 2; }
        
        @keyframes spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        #notice { display: none; }
        
        #slider {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            display: block;
            text-align: center;
            padding-top: 20px;
            z-index: 1;
        }
        
        #well {
            width: 80%;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            position: relative;
            margin: 0 auto;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        #well:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        #well.dragging {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 107, 107, 0.5);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }
        
        #thumbtack {
            position: absolute;
            left: 10px;
            top: 50%;
            margin-top: -20px;
            width: 40px;
            height: 40px;
            background: #ff6b6b;
            border-radius: 50%;
            transition: left 0.2s ease-out;
            cursor: grab;
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.15);
        }
        #thumbtack::after {
            content: "➜";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            line-height: 1;
            pointer-events: none;
            text-shadow: 0 1px 1px rgba(0,0,0,0.3);
        }
        
        #thumbtack:active {
            cursor: grabbing;
        }
        
        #hint {
            position: absolute;
            left: 60px;
            top: 50%;
            margin-top: -10px;
            color: #fff;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: color 0.3s ease;
        }
        
        /* Hidden PWA UI */
        .pwa-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            z-index: 1000;
            display: none;
            overflow-y: auto;
        }
        
        .pwa-container.visible {
            display: block;
        }
        
        .pwa-header {
            background: #667eea;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            margin-top: -15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .pwa-content {
            padding: 20px;
        }
        
        .pwa-title-container {
            text-align: center;
        }
        
        .pwa-logo {
            width: 40px;
            height: 40px;
            margin: 0 10px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .time { font-size: 2rem; }
            :root { --logo-size: clamp(140px, 46vw, 220px); --backdrop-size: calc(var(--logo-size) + 36px); }
            #notice { font-size: 1.2rem; }
            .theme-menu { width: 280px; right: -280px; }
        }
        /* Landscape tweaks */
        @media (orientation: landscape) {
            :root { --logo-size: clamp(110px, 24vh, 200px); --backdrop-size: calc(var(--logo-size) + 28px); }
            #main { min-height: 40vh; }
        }
        
        /* Theme Styles */
        .theme-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .theme-classic {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .theme-dark {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        .theme-cyber {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
        }

        /* Extra combos */
        .theme-matrix {
            background: #000000;
        }
        .theme-neon {
            background: linear-gradient(135deg, #00ff88 0%, #00e1ff 100%);
        }
        /* Chimera theme system with variants */
        .theme-chimera {
            color: rgba(20,40,50,0.9);
            --chimera-accent: #3cc1b2;
        }
        /* Light (pastel) */
        .theme-chimera.chimera-light { background: linear-gradient(135deg, #dff8ff 0%, #e9f7f0 40%, #f7eaf3 100%); }
        /* Green gradient variant */
        .theme-chimera.chimera-green { background: linear-gradient(180deg, #00c6ff 0%, #19d28b 55%, #f3c912 120%); }
        /* Dark/grey variant */
        .theme-chimera.chimera-dark { background: linear-gradient(135deg, #0f172a 0%, #1f2937 100%); color: #e5f8f5; }
        .theme-chimera header.block {
            background: transparent;
            border: none;
            box-shadow: none;
        }
        .theme-chimera .time { color: var(--chimera-accent, #3cc1b2); }
        .theme-chimera .date { color: #7cc6f1; }
        .theme-chimera #logo-wrap { border: 2px solid color-mix(in srgb, var(--chimera-accent, #3cc1b2) 65%, transparent); }
        .theme-chimera #logo { box-shadow: inset 0 0 0 8px rgba(255,255,255,0.12); }
        /* Center label inside ring, matching Chimera */
        .theme-chimera #logo-wrap::after {
            content: 'Jailbreak';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-weight: 600;
            color: rgba(60,193,178,0.85);
            pointer-events: none;
            font-size: clamp(12px, 3vw, 16px);
            z-index: 1; /* beneath logo (z-index 2) */
        }
        .theme-chimera #logo-backdrop {
            background: var(--card-bg, linear-gradient(135deg, #e7f9fb 0%, #f3eaf0 100%));
            border-radius: 36px;
            box-shadow: 0 18px 56px rgba(0,0,0,0.22), inset 0 0 0 1px rgba(255,255,255,0.6);
        }
        /* Ensure visible white card even in dark variant */
        body.theme-chimera.chimera-dark { --card-bg: #eaf2f8; }
        .theme-chimera #notice { color: #c7b3ff; }
        .theme-chimera #slider { background: rgba(255,255,255,0.06); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); padding-bottom: env(safe-area-inset-bottom); }
        .theme-chimera #well {
            background: rgba(255,255,255,0.2);
            border: 2px solid color-mix(in srgb, var(--chimera-accent, #3cc1b2) 45%, transparent);
        }
        .theme-chimera #thumbtack {
            background: rgba(255,255,255,0.85);
            border: 2px solid color-mix(in srgb, var(--chimera-accent, #3cc1b2) 65%, transparent);
            color: var(--chimera-accent, #3cc1b2);
        }
        .theme-chimera #thumbtack::after { color:#ffffff; text-shadow: none; }
        /* Variant-specific accent overrides */
        .theme-chimera.chimera-green { --chimera-accent: #25c29b; }
        .theme-chimera.chimera-dark { --chimera-accent: #35d0bf; }
        .theme-vapor {
            background: linear-gradient(135deg, #ff9a9e 0%, #a18cd1 100%);
        }

        /* Accessible animated background (crazycolors) */
        :root { --bg-motion-speed: 60s; }
        body.bg-crazycolors {
            background: linear-gradient(45deg,#ff0066,#ff8800,#ffee00,#33ff99,#00ccff,#9966ff,#ff33cc);
            background-size: 400% 400%;
            animation: bgShift var(--bg-motion-speed) ease-in-out infinite;
        }
        /* Motion speed presets */
        body.motion-slow { --bg-motion-speed: 120s; }
        body.motion-fast { --bg-motion-speed: 15s; }
        body.motion-slow #logo { animation-duration: 8s; }
        body.motion-fast #logo { animation-duration: 3s; }
        @keyframes bgShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Respect OS reduce-motion */
        @media (prefers-reduced-motion: reduce) {
            body.bg-crazycolors { animation: none !important; }
        }

        /* Low-effects mode for older WebKit / standalone to avoid WSOD */
        body.lowfx { -webkit-font-smoothing: antialiased; }
        body.lowfx .theme-menu { transition: none !important; }
        body.lowfx #logo { animation: spin 8s linear infinite !important; }
        body.lowfx.bg-crazycolors { animation: none !important; }
        body.paused * { animation-play-state: paused !important; }
        /* Never pause spinning logo to keep visual heartbeat when offline */
        body.paused #logo { animation-play-state: running !important; }
    </style>
    <!-- External theme files (editable/exportable) -->
    <link rel="stylesheet" href="../../.CSSThemes/exploit-compact/chimera-light.css">
    <link rel="stylesheet" href="../../.CSSThemes/exploit-compact/chimera-green.css">
    <link rel="stylesheet" href="../../.CSSThemes/exploit-compact/chimera-dark.css">
    <link rel="stylesheet" href="../../.CSSThemes/exploit-compact/modern.css">
    <link rel="stylesheet" href="../../.CSSThemes/exploit-compact/classic.css">
    <link rel="stylesheet" href="../../.CSSThemes/exploit-compact/dark-red.css">
    <!-- Load exploit scripts (absolute paths from site root) -->
    <script src="../../utils.js"></script>
    <script src="../../helper.js"></script>
    <script src="../../int64.js"></script>
    <script src="../../stages.js"></script>
    <script src="../../offsets.js"></script>
    <script src="../../pwn.js?v=20250813a"></script>
</head>
<body class="theme-chimera motion-slow">
    <!-- Loading State -->
    <div class="loading" id="loading">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Exploit...</div>
        </div>
    </div>
    
    <!-- Error State (hidden by default) -->
    <div class="error-state" id="errorState">
        <div class="error-icon">⚠️</div>
        <h2>Something went wrong</h2>
        <p>The exploit interface failed to load properly.</p>
        <button class="retry-button" onclick="retryLoad()">Retry</button>
    </div>
    
    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <!-- Hamburger Menu -->
        <div class="hamburger" onclick="toggleThemeMenu()" aria-label="Open theme menu" role="button">
            <div class="gear">⚙️</div>
        </div>
    
    <!-- Theme Menu -->
    <div class="theme-menu" id="themeMenu">
        <h3>🎨 Theme Selector</h3>
        <div class="theme-option" data-key="darkvelvet" onclick="selectTheme('dark')">
            <strong>Dark Velvet</strong><br>
            <small>Classic black & red</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="modern" onclick="selectTheme('modern')">
            <strong>Modern</strong><br>
            <small>Blue & purple gradient</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="classic" onclick="selectTheme('classic')">
            <strong>Classic</strong><br>
            <small>Pink & red gradient</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="darkred" onclick="selectTheme('dark')">
            <strong>Dark/Red</strong><br>
            <small>Dark base, red accents</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="cyber" onclick="selectTheme('cyber')">
            <strong>Cyber</strong><br>
            <small>Blue & cyan gradient</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="matrix" onclick="selectTheme('matrix')">
            <strong>Matrix</strong><br>
            <small>Black, neon vibe</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="neon" onclick="selectTheme('neon')">
            <strong>Neon</strong><br>
            <small>Green & cyan pop</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="chimera" onclick="selectTheme('chimera')">
            <strong>Chimera</strong><br>
            <small>Soft minimalist</small>
            <div class="chimera-toggle">
                <div class="toggle-row">
                    <span class="icon-sun">☀️</span>
                    <label class="switch" onclick="event.stopPropagation();">
                        <input type="checkbox" id="chimera-dark-toggle" onchange="event.stopPropagation(); chimeraToggleChanged(this)">
                        <span class="slider"></span>
                    </label>
                    <span class="icon-moon">🌙</span>
                    <button class="more-link" type="button" onclick="event.stopPropagation(); toggleChimeraSubthemes();">Subthemes ▾</button>
                </div>
            </div>
            <div id="chimera-subthemes" class="subthemes">
                <div class="theme-option subtheme-option" data-key="chimera-light" onclick="setChimeraVariant('light')">
                    <strong>Chimera · Light</strong><br>
                    <small>Pastel gradient</small>
                </div>
                <div class="theme-option subtheme-option" data-key="chimera-green" onclick="setChimeraVariant('green')">
                    <strong>Chimera · Green</strong><br>
                    <small>Greenish gradient</small>
                </div>
                <div class="theme-option subtheme-option" data-key="chimera-dark" onclick="setChimeraVariant('dark')">
                    <strong>Chimera · Dark</strong><br>
                    <small>Grey/Dark mode</small>
                </div>
            </div>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="vapor" onclick="selectTheme('vapor')">
            <strong>Vapor</strong><br>
            <small>Pink & purple haze</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="crazycolors" onclick="toggleCrazyColors()">
            <strong>Crazy Colors</strong><br>
            <small>Animated gradient background</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="motion-slow" onclick="setMotionSpeed('slow')">
            <strong>Motion: Slow</strong><br>
            <small>Comfort-first (recommended)</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="motion-normal" onclick="setMotionSpeed('normal')">
            <strong>Motion: Normal</strong><br>
            <small>Original speed</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
        <div class="theme-option" data-key="motion-fast" onclick="setMotionSpeed('fast')">
            <strong>Motion: Fast</strong><br>
            <small>For demos only</small>
            <span class="drag-handle" aria-label="Drag to reorder">≡</span>
        </div>
    </div>
    
    <!-- Original Exploit Interface -->
    <header class="block">
        <div class="time">12<span class="colon">:</span>00</div>
        <div class="date">Reckoning Day</div>
    </header>
    
    <div id="main" style="position:relative; min-height: 55vh;">
        <div id="logo-group">
            <div id="logo-backdrop" aria-hidden="true"></div>
            <div id="logo-wrap" onclick="openLogoMenu()" aria-label="Open options">
                <img id="logo" src="https://totally.not.spyware.lol/img/ios-icon.png" alt="logo" onerror="this.onerror=null;this.src='../../icons/TotallyNotSpyware.png'" referrerpolicy="no-referrer" crossorigin="anonymous">
            </div>
        </div>
        <div id="notice"></div>
    </div>
    
    <div id="slider">
        <div id="well" onclick="slideAction()">
            <div id="thumbtack"></div>
            <div id="hint">slide for spyware</div>
        </div>
    </div>
    
    <!-- Hidden PWA Container -->
    <div class="pwa-container" id="pwaContainer">
        <div class="pwa-header">
            <button class="back-button" onclick="hidePWA()">← Back to Exploit</button>
            <div class="pwa-title-container">
                <img src="https://totally.not.spyware.lol/img/amazing.png" alt="TotallyNotSpyware" class="pwa-logo">
                <h1>TotallyNotSpyware v2</h1>
            </div>
            <p>iOS 12 Chimera Re-Jailbreak Utility</p>
        </div>
        
        <div class="pwa-content">
            <div id="pwaContent">
                <h2>PWA Interface</h2>
                <p>This is where our main PWA interface will be displayed.</p>
                <p>You can navigate back to the exploit interface using the back button above.</p>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize the application safely
        function initializeApp() {
            try {
                // Default theme: Chimera (restore variant)
                (function setDefaultTheme(){
                    var body = document.body;
                    body.classList.remove('theme-modern','theme-classic','theme-dark','theme-cyber','theme-matrix','theme-neon','theme-vapor');
                    body.classList.add('theme-chimera');
                    var params = new URLSearchParams(location.search);
                    var qVar = params.get('chimera');
                    var savedVar = localStorage.getItem('chimera-variant') || 'light';
                    var variant = (qVar && ['light','green','dark'].indexOf(qVar) !== -1) ? qVar : savedVar;
                    // Persist chosen variant; apply silently during init
                    try { localStorage.setItem('chimera-variant', variant); } catch(_){ }
                    setChimeraVariant(variant, true);
                })();
                // Initialize time update
                updateTime();
                setInterval(updateTime, 1000);
                
                // Initialize touch events safely
                initializeTouchEvents();
                // Log init + self-check (match legacy info)
                logMessage('App initialized (Exploit-Compact)', 'info');
                compactSelfCheck();
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('App initialization failed:', error);
                showErrorState();
            }
        }

        // Simple in-memory activity log and dumper
        (function(){
            var _log = [];
            function renderIntoKnownContainers(){
                try {
                    var html = _log.map(function(l){ return '<div>'+l+'</div>'; }).join('');
                    var c1 = document.getElementById('logoMenuLog');
                    if (c1) c1.innerHTML = html;
                    var c2 = document.getElementById('log-content-panel'); // legacy id
                    if (c2) c2.innerHTML = html;
                } catch(_){}
            }
            window.activityLog = {
                push: function(msg){
                    try { _log.push('[' + new Date().toLocaleTimeString() + '] ' + msg); } catch(_){}
                    renderIntoKnownContainers();
                },
                dumpInto: function(container){ try { if (!container) return; container.innerHTML = _log.map(function(l){ return '<div>'+l+'</div>'; }).join(''); } catch(_){} },
                _render: renderIntoKnownContainers
            };
            window.dumpActivityLogTo = function(el){ activityLog.dumpInto(el); };
        })();

        function logMessage(message, type){
            try { if (window.activityLog) window.activityLog.push(message); } catch(_){}
            try { console.log((type?('['+type+'] '):'') + message); } catch(_){}
        }

        function compactSelfCheck(){
            try {
                var scripts = Array.prototype.slice.call(document.querySelectorAll('script[src]')).map(function(s){ return s.src; });
                function present(name){ return scripts.some(function(s){ return s.indexOf(name) !== -1; }); }
                var files = ['pwn.js','stages.js','offsets.js','int64.js','helper.js','utils.js'];
                for (var i=0;i<files.length;i++){
                    var ok = present(files[i]);
                    logMessage((ok? '✔ ':'✖ ') + files[i], ok ? 'success' : 'error');
                }
                var hasPwn = (typeof window.pwn === 'function');
                logMessage('window.pwn: ' + (hasPwn ? 'available' : 'missing'), hasPwn ? 'success' : 'error');
                var ua = navigator.userAgent;
                var isIOS = /iPad|iPhone|iPod/i.test(ua);
                var isWebKit = /WebKit/i.test(ua);
                logMessage('Platform: iOS=' + (isIOS?'true':'false') + ' WebKit=' + (isWebKit?'true':'false'), (isIOS && isWebKit) ? 'success' : 'error');
                if ('serviceWorker' in navigator && navigator.serviceWorker.getRegistration) {
                    navigator.serviceWorker.getRegistration().then(function(reg){
                        logMessage('SW: ' + (reg ? 'registered' : 'not registered'), reg ? 'success' : 'error');
                    });
                }
            } catch(e){ logMessage('Self-check error: ' + e.message, 'error'); }
        }

        // Live vs cached detection and badge update
        function detectLiveStatus(badgeEl, noteEl){
            try {
                var isLocal = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
                var isGhPages = /github\.io$/.test(location.hostname);
                var swControlled = !!(navigator.serviceWorker && navigator.serviceWorker.controller);
                // Heuristic: on GH Pages, if a SW is controlling this page, it might be cached/offline
                // Also consider page URL containing a cache-buster as indicative of fresh fetch
                var hasBuster = /[?&]v=|[?&]_ts=/.test(location.search);
                var live = isLocal || hasBuster || (!swControlled);
                var cls = live ? 'status-live' : (swControlled ? 'status-cached' : 'status-unknown');
                var label = live ? 'LIVE' : (swControlled ? 'CACHED' : 'UNKNOWN');
                if (badgeEl) { badgeEl.className = 'status-badge ' + cls; badgeEl.textContent = label; }
                if (noteEl) {
                    if (live) noteEl.textContent = isLocal ? 'Serving directly from localhost' : 'Fresh network fetch (or cache-busted)';
                    else if (swControlled) noteEl.textContent = 'Served by Service Worker cache (offline/fast)';
                    else noteEl.textContent = 'Could not determine source';
                }
            } catch(_){}
        }
        
        // Safe touch event initialization
        function initializeTouchEvents() {
            try {
                const thumbtack = document.getElementById('thumbtack');
                if (!thumbtack) {
                    console.warn('Thumbtack element not found');
                    return;
                }
                
                // Touch events for mobile
                thumbtack.addEventListener('touchstart', handleTouchStart, {passive:false});
                document.addEventListener('touchmove', handleTouchMove, {passive:false});
                document.addEventListener('touchend', handleTouchEnd, {passive:false});
                
                // Mouse events for desktop
                thumbtack.addEventListener('mousedown', handleMouseDown);
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                
                console.log('Touch events initialized');
            } catch (error) {
                console.error('Touch event initialization failed:', error);
            }
        }
        
        // Simple time update
        function updateTime() {
            try {
                var now = new Date();
                var hours = now.getHours().toString();
                var minutes = now.getMinutes().toString();
                if (hours.length < 2) hours = '0' + hours;
                if (minutes.length < 2) minutes = '0' + minutes;
                
                const timeElement = document.querySelector('.time');
                if (timeElement) {
                    timeElement.innerHTML = hours + '<span class="colon">:</span>' + minutes;
                }

                // Dynamically center the logo group between header and slider
                try {
                    var header = document.querySelector('header.block');
                    var slider = document.getElementById('slider');
                    var group = document.getElementById('logo-group');
                    if (header && slider && group) {
                        var hRect = header.getBoundingClientRect();
                        var sRect = slider.getBoundingClientRect();
                        var gap = Math.max(20, (sRect.top - hRect.bottom));
                        var mid = hRect.bottom + gap/2;
                        var top = Math.max(hRect.bottom + 12, mid);
                        group.style.top = Math.round(top) + 'px';
                    }
                } catch(_){ }
            } catch (error) {
                console.error('Time update failed:', error);
            }
        }
        
        // Toggle theme menu
        function toggleThemeMenu() {
            try {
                var menu = document.getElementById('themeMenu');
                var hamburger = document.querySelector('.hamburger');
                if (menu && hamburger) {
                    menu.classList.toggle('active');
                    hamburger.classList.toggle('active');
                    if (menu.classList.contains('active')) {
                        enableThemeDrag(menu);
                        restoreThemeOrder(menu);
                        updateActiveMenuState(menu);
                    }
                }
            } catch (error) {
                console.error('Theme menu toggle failed:', error);
            }
        }

        // Make the hamburger draggable (no bounds)
        (function enableHamburgerDrag(){
            try {
                var burger = document.querySelector('.hamburger');
                if (!burger) return;

                var isDown = false, startX = 0, startY = 0, origLeft = 0, origTop = 0;

                function ensurePositioning(){
                    var cs = window.getComputedStyle(burger);
                    if (cs.position !== 'fixed' && cs.position !== 'absolute') {
                        burger.style.position = 'fixed';
                    }
                    // Initialize top/left if not set
                    if (!burger.style.left) burger.style.left = cs.left;
                    if (!burger.style.top) burger.style.top = cs.top;
                    burger.style.right = 'auto';
                    burger.style.bottom = 'auto';
                }

                // Mouse
                burger.addEventListener('mousedown', function(e){
                    // Don’t start drag if a click opens/closes menu unless user actually moves
                    ensurePositioning();
                    isDown = true;
                    burger.classList.add('dragging');
                    startX = e.clientX; startY = e.clientY;
                    origLeft = parseInt(burger.style.left || 0) || burger.getBoundingClientRect().left;
                    origTop = parseInt(burger.style.top || 0) || burger.getBoundingClientRect().top;
                });
                document.addEventListener('mousemove', function(e){
                    if (!isDown) return;
                    var dx = e.clientX - startX;
                    var dy = e.clientY - startY;
                    burger.style.left = (origLeft + dx) + 'px';
                    burger.style.top = (origTop + dy) + 'px';
                });
                document.addEventListener('mouseup', function(){
                    if (!isDown) return; isDown = false; burger.classList.remove('dragging');
                });

                // Touch
                burger.addEventListener('touchstart', function(e){
                    var t = e.touches[0];
                    ensurePositioning();
                    isDown = true; burger.classList.add('dragging');
                    startX = t.clientX; startY = t.clientY;
                    origLeft = parseInt(burger.style.left || 0) || burger.getBoundingClientRect().left;
                    origTop = parseInt(burger.style.top || 0) || burger.getBoundingClientRect().top;
                    e.preventDefault();
                }, {passive:false});
                document.addEventListener('touchmove', function(e){
                    if (!isDown) return;
                    var t = e.touches[0];
                    var dx = t.clientX - startX;
                    var dy = t.clientY - startY;
                    burger.style.left = (origLeft + dx) + 'px';
                    burger.style.top = (origTop + dy) + 'px';
                    e.preventDefault();
                }, {passive:false});
                document.addEventListener('touchend', function(){
                    if (!isDown) return; isDown = false; burger.classList.remove('dragging');
                });
            } catch (e) { console.error('Hamburger drag failed', e); }
        })();

        // Drag and drop reordering with persistence
        function getTopLevelOptions(menu){
            try {
                return Array.prototype.filter.call(menu.children, function(el){
                    return el.classList && el.classList.contains('theme-option');
                });
            } catch(_) { return []; }
        }

        function enableThemeDrag(menu){
            if (!menu || menu._dragEnabled) return;
            menu._dragEnabled = true;
            var dragging = null;
            var placeholder = document.createElement('div');
            placeholder.className = 'drag-placeholder';
            var longPressTimer = null;
            var ghost = null, ghostOffsetY = 0;
            var suppressClickOnce = false;
            var suppressClickUntil = 0;
            var awaitingItem = null, awaitingTimer = null, pressX = 0, pressY = 0;

            function scheduleLongPress(targetItem, x, y){
                cancelLongPress();
                awaitingItem = targetItem; pressX = x||0; pressY = y||0;
                awaitingTimer = setTimeout(function(){ startDrag(targetItem); cancelLongPress(); }, 350);
            }
            function cancelLongPress(){
                if (awaitingTimer) { clearTimeout(awaitingTimer); awaitingTimer = null; }
                awaitingItem = null;
            }

            function startDrag(item){
                dragging = item;
                item.classList.add('dragging-item');
                // Insert right after the dragged item to start
                var rect = item.getBoundingClientRect();
                placeholder.style.height = rect.height + 'px';
                item.parentNode.insertBefore(placeholder, item); // occupy original position
                item.classList.add('dragging-hidden');

                // Create a visual ghost following the cursor
                ghost = item.cloneNode(true);
                ghost.classList.remove('dragging-hidden');
                ghost.classList.remove('dragging-item');
                ghost.classList.add('drag-ghost');
                ghost.style.width = rect.width + 'px';
                ghost.style.height = rect.height + 'px';
                ghost.style.left = rect.left + 'px';
                ghost.style.top = rect.top + 'px';
                ghostOffsetY = rect.height / 2;
                document.body.appendChild(ghost);
            }
            function endDrag(){
                if (!dragging) return;
                dragging.classList.remove('dragging-item');
                dragging.classList.remove('dragging-hidden');
                if (placeholder.parentNode){
                    // Ensure we never place above the header (h3) by only inserting relative to theme-option elements
                    placeholder.parentNode.insertBefore(dragging, placeholder);
                    placeholder.parentNode.removeChild(placeholder);
                }
                if (ghost) { ghost.remove(); ghost = null; }
                dragging = null;
                saveThemeOrder(menu);
                suppressClickOnce = true; // require one more tap after a drag (iOS12-friendly)
                suppressClickUntil = Date.now() + 350;
            }
            function onMove(y){
                if (!dragging) return;
                var items = getTopLevelOptions(menu);
                var placed = false;
                items.forEach(function(it){
                    var r = it.getBoundingClientRect();
                    if (y < r.top + r.height/2 && it !== dragging && it !== placeholder && !placed){
                        menu.insertBefore(placeholder, it); placed = true;
                    }
                });
                if (!placed) {
                    // Move to very end (but still inside list under header)
                    menu.appendChild(placeholder);
                }
                if (ghost) {
                    var x = window.scrollX + (ghost.getBoundingClientRect().left);
                    ghost.style.top = (y - ghostOffsetY) + 'px';
                }
            }
            function bindItem(item){
                var handle = item.querySelector('.drag-handle');
                if (!handle) return;
                handle.addEventListener('mousedown', function(e){ e.preventDefault(); scheduleLongPress(item, e.clientX, e.clientY); });
                document.addEventListener('mousemove', function(e){
                    if (awaitingItem && (Math.abs(e.clientX-pressX)>6 || Math.abs(e.clientY-pressY)>6)) cancelLongPress();
                    if (dragging) onMove(e.clientY);
                });
                document.addEventListener('mouseup', function(){ cancelLongPress(); if (dragging) endDrag(); });
                // Touch long-press on handle
                handle.addEventListener('touchstart', function(e){ var t=e.touches[0]; scheduleLongPress(item, t.clientX, t.clientY); }, {passive:true});
        document.addEventListener('touchmove', function(e){ if (awaitingItem){ var t=e.touches[0]; if (Math.abs(t.clientX-pressX)>6 || Math.abs(t.clientY-pressY)>6) cancelLongPress(); } if (dragging) { onMove(e.touches[0].clientY); e.preventDefault(); } }, {passive:false});
                document.addEventListener('touchend', function(){ cancelLongPress(); if (dragging) endDrag(); });

                // Whole-card long-press to drag (for users not hitting the handle)
                item.addEventListener('mousedown', function(e){ if (e.target === handle) return; scheduleLongPress(item, e.clientX, e.clientY); });
                item.addEventListener('mouseup', function(){ cancelLongPress(); });
                item.addEventListener('mouseleave', function(){ cancelLongPress(); });
                item.addEventListener('touchstart', function(e){ var t=e.touches[0]; scheduleLongPress(item, t.clientX, t.clientY); }, {passive:true});
                item.addEventListener('touchend', function(){ cancelLongPress(); });
                item.addEventListener('click', function(e){
                    // Never block clicks on inner controls
                    if (e.target.closest('.drag-handle, .switch, .more-link')) return;
                    if (suppressClickOnce && Date.now() < suppressClickUntil) {
                        e.preventDefault(); e.stopPropagation();
                        suppressClickOnce = false;
                        return;
                    }
                });
            }
            getTopLevelOptions(menu).forEach(bindItem);
        }

        // Theme helpers
        var KNOWN_THEME_CLASSES = ['theme-modern','theme-classic','theme-dark','theme-cyber','theme-matrix','theme-neon','theme-vapor','theme-chimera'];
        function removeThemeClasses(){
            try{
                KNOWN_THEME_CLASSES.forEach(function(c){ document.body.classList.remove(c); });
                document.body.classList.remove('chimera-light','chimera-green','chimera-dark');
            }catch(_){ }
        }
        function getActiveThemeKey(){
            var body = document.body;
            if (body.classList.contains('theme-chimera')){
                var v = 'light';
                if (body.classList.contains('chimera-green')) v = 'green';
                else if (body.classList.contains('chimera-dark')) v = 'dark';
                return ['chimera','chimera-'+v];
            }
            var mapping = ['modern','classic','dark','cyber','matrix','neon','vapor'];
            for (var i=0;i<mapping.length;i++){
                if (body.classList.contains('theme-'+mapping[i])) return ['theme-'+mapping[i]].map(function(x){return x.replace('theme-','');});
            }
            return ['default'];
        }
        function updateActiveMenuState(menu){
            try{
                menu = menu || document.getElementById('themeMenu');
                if (!menu) return;
                var activeKeys = getActiveThemeKey();
                menu.querySelectorAll('.theme-option').forEach(function(o){ o.classList.remove('active'); });
                activeKeys.forEach(function(k){
                    var el = menu.querySelector('.theme-option[data-key="'+k+'"]');
                    if (el) el.classList.add('active');
                });
            }catch(_){ }
        }

        function saveThemeOrder(menu){
            try{
                var keys = getTopLevelOptions(menu).map(function(el){ return el.getAttribute('data-key') || ''; }).filter(Boolean);
                localStorage.setItem('theme-order', JSON.stringify(keys));
            }catch(_){ }
        }
        function restoreThemeOrder(menu){
            try{
                var raw = localStorage.getItem('theme-order');
                var order = raw ? JSON.parse(raw) : null;
                var map = {};
                getTopLevelOptions(menu).forEach(function(el){ var k = el.getAttribute('data-key'); if (k) map[k]=el; });
                if (!order) {
                    // Default order: Chimera first, keep others as-is
                    order = Object.keys(map);
                    var idx = order.indexOf('chimera');
                    if (idx > 0) { order.splice(idx,1); order.unshift('chimera'); }
                    localStorage.setItem('theme-order', JSON.stringify(order));
                }
                order.forEach(function(k){ if (map[k]) { menu.appendChild(map[k]); delete map[k]; } });
                // Append any items not in saved order (new entries)
                Object.keys(map).forEach(function(k){ menu.appendChild(map[k]); });
            }catch(_){ }
        }
        
        // Select theme
        function selectTheme(theme) {
            try {
                // Remove all theme classes
                // Preserve chimera variant if switching among chimera variants
                var currentVariant = (document.body.className.match(/chimera-(light|green|dark)/)||[])[0] || 'chimera-light';
                removeThemeClasses();
                
                // Add selected theme
                var allowed = ['default','modern','classic','dark','cyber','matrix','neon','chimera','vapor'];
                if (theme !== 'default' && allowed.indexOf(theme) !== -1) {
                    document.body.classList.add('theme-' + theme);
                    if (theme === 'chimera') {
                        // Apply stored or current variant
                        var saved = localStorage.getItem('chimera-variant') || currentVariant.replace('chimera-','');
                        setChimeraVariant(saved, true);
                    }
                }
                
                updateActiveMenuState();
                
                // Close menu
                toggleThemeMenu();
            } catch (error) {
                console.error('Theme selection failed:', error);
            }
        }

        // Chimera variants subsystem
        function setChimeraVariant(variant, silent) {
            try {
                if (!['light','green','dark'].includes(variant)) variant = 'light';
                // Remove previous variant classes
                document.body.classList.remove('chimera-light','chimera-green','chimera-dark');
                // Ensure chimera base theme exists
                if (!document.body.classList.contains('theme-chimera')) {
                    document.body.classList.add('theme-chimera');
                }
                document.body.classList.add('chimera-' + variant);
                localStorage.setItem('chimera-variant', variant);
                // Update subtheme toggle title
                var btn = document.querySelector('.chimera-toggle .more-link');
                if (btn) btn.textContent = 'Subthemes ▾';
                var darkToggle = document.getElementById('chimera-dark-toggle');
                if (darkToggle) darkToggle.checked = (variant === 'dark');
                var panel = document.getElementById('chimera-subthemes');
                if (panel) panel.classList.remove('open');
                if (!silent) {
                    // Close menu for immediate feedback
                    var menu = document.getElementById('themeMenu');
                    if (menu && menu.classList.contains('active')) toggleThemeMenu();
                }
                updateActiveMenuState();
            } catch(err) { console.error('Set Chimera variant failed:', err); }
        }

        function toggleChimeraSubthemes(){
            var panel = document.getElementById('chimera-subthemes');
            if (!panel) return;
            panel.classList.toggle('open');
            var btn = document.querySelector('.chimera-toggle .more-link');
            if (btn) btn.textContent = panel.classList.contains('open') ? 'Subthemes ▴' : 'Subthemes ▾';
        }

        function chimeraToggleChanged(el){
            setChimeraVariant(el && el.checked ? 'dark' : 'light');
        }
        
        // Reveal PWA interface
        function revealPWA() {
            try {
                const container = document.getElementById('pwaContainer');
                if (container) {
                    container.className = 'pwa-container visible';
                }
            } catch (error) {
                console.error('PWA reveal failed:', error);
            }
        }

        // Swap logo to external .lol if available; fallback to local icon
        // spinning logo uses external .lol icon with circular mask; falls back to local if it fails

        // Logo menu: choose legacy UI or text-only exploit
        function openLogoMenu() {
            try {
                var menu = document.createElement('div');
                menu.className = 'theme-menu active';
                menu.style.right = '0';
                menu.innerHTML = `
                    <h3>🧪 Exploit Options</h3>
                    <div class="status-row">
                        <span id="liveStatusBadge" class="status-badge status-unknown">Detecting…</span>
                        <small id="liveStatusNote" style="opacity:.8"></small>
                    </div>
                    <div class="theme-option" onclick="window.location.href='legacy.html'">
                        <strong>Legacy UI</strong><br>
                        <small>Original visual interface</small>
                    </div>
                    <div class="theme-option" onclick="window.open('https://jbme.h4ck.kr','_blank')">
                        <strong>Simple JB</strong><br>
                        <small>Minimal website to execute the exploit on compatible devices</small>
                    </div>
                    <div class="theme-option" onclick="window.open('/webclip/repo/','_blank')">
                        <strong>Download .deb repo</strong><br>
                        <small>Open local APT repo directory</small>
                    </div>
                    <div class="theme-option" onclick="window.open('https://github.com/wh1te4ever/totally-not-spyware-v2-release','_blank')">
                        <strong>Source code</strong><br>
                        <small>totally-not-spyware-v2-release</small>
                    </div>
                    <div class="theme-option" onclick="this.parentNode.remove()">
                        <strong>Close</strong>
                    </div>
                    <div class="activity-log">
                        <div class="log-title">📋 Activity Log</div>
                        <div id="logoMenuLog"></div>
                    </div>
                `;
                document.body.appendChild(menu);
                try {
                    dumpActivityLogTo(menu.querySelector('#logoMenuLog'));
                    if (window.activityLog && activityLog._render) activityLog._render();
                } catch(_){}
                try { detectLiveStatus(menu.querySelector('#liveStatusBadge'), menu.querySelector('#liveStatusNote')); } catch(_){}
            } catch (error) {
                console.error('Logo menu failed:', error);
                window.location.href = 'legacy.html';
            }
        }

        // Toggle animated background with accessibility respect
        function toggleCrazyColors() {
            try {
                var prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                var body = document.body;
                if (body.classList.contains('bg-crazycolors')) {
                    body.classList.remove('bg-crazycolors');
                    localStorage.removeItem('crazycolors');
                } else {
                    if (prefersReduced) {
                        alert('Animated background is disabled by your Reduce Motion setting. You can enable it in system settings.');
                        return;
                    }
                    body.classList.add('bg-crazycolors');
                    // slower motion for comfort
                    document.documentElement.style.setProperty('--bg-motion-speed', '120s');
                    localStorage.setItem('crazycolors', 'on');
                }
            } catch (e) { console.error('Crazy colors toggle failed:', e); }
        }

        // Restore preference on load
        (function(){
            try {
                if (localStorage.getItem('crazycolors')==='on') toggleCrazyColors();
                var ms = localStorage.getItem('motion-speed') || 'slow';
                setMotionSpeed(ms);
            } catch(_){}
        })();

        function setMotionSpeed(mode) {
            try {
                var body = document.body;
                body.classList.remove('motion-slow','motion-fast');
                if (mode === 'slow') body.classList.add('motion-slow');
                else if (mode === 'fast') body.classList.add('motion-fast');
                // 'normal' -> no class = default 60s
                localStorage.setItem('motion-speed', mode);
            } catch(e) { console.error('Set motion speed failed:', e); }
        }
        
        // Hide PWA interface
        function hidePWA() {
            try {
                const container = document.getElementById('pwaContainer');
                if (container) {
                    container.className = 'pwa-container';
                }
            } catch (error) {
                console.error('PWA hide failed:', error);
            }
        }
        
        // Enhanced slide action with touch support
        let isDragging = false;
        let startX = 0;
        let initialLeft = 10;
        
        // Touch events for mobile
        document.getElementById('thumbtack').addEventListener('touchstart', handleTouchStart);
        document.addEventListener('touchmove', handleTouchMove, {passive:false});
        document.addEventListener('touchend', handleTouchEnd);
        
        // Mouse events for desktop
        document.getElementById('thumbtack').addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        
        function handleTouchStart(e) {
            try {
                isDragging = true;
                startX = e.touches[0].clientX;
                initialLeft = parseInt(document.getElementById('thumbtack').style.left) || 10;
                const well = document.getElementById('well');
                if (well) well.classList.add('dragging');
                e.preventDefault();
            } catch (error) {
                console.error('Touch start failed:', error);
                isDragging = false;
            }
        }
        
        function handleTouchMove(e) {
            try {
                if (!isDragging) return;
                e.preventDefault();
                
                const currentX = e.touches[0].clientX;
                const deltaX = currentX - startX;
                const well = document.getElementById('well');
                const thumbtack = document.getElementById('thumbtack');
                
                if (well && thumbtack) {
                    const wellRect = well.getBoundingClientRect();
                    let newLeft = Math.max(10, Math.min(wellRect.width - 50, initialLeft + deltaX));
                    thumbtack.style.left = newLeft + 'px';
                }
            } catch (error) {
                console.error('Touch move failed:', error);
                isDragging = false;
            }
        }
        
        function handleTouchEnd() {
            try {
                if (!isDragging) return;
                isDragging = false;
                const well = document.getElementById('well');
                if (well) well.classList.remove('dragging');
                checkSlideCompletion();
            } catch (error) {
                console.error('Touch end failed:', error);
            }
        }
        
        function handleMouseDown(e) {
            try {
                isDragging = true;
                startX = e.clientX;
                initialLeft = parseInt(document.getElementById('thumbtack').style.left) || 10;
                const well = document.getElementById('well');
                if (well) well.classList.add('dragging');
                e.preventDefault();
            } catch (error) {
                console.error('Mouse down failed:', error);
                isDragging = false;
            }
        }
        
        function handleMouseMove(e) {
            try {
                if (!isDragging) return;
                
                const currentX = e.clientX;
                const deltaX = currentX - startX;
                const well = document.getElementById('well');
                const thumbtack = document.getElementById('thumbtack');
                
                if (well && thumbtack) {
                    const wellRect = well.getBoundingClientRect();
                    let newLeft = Math.max(10, Math.min(wellRect.width - 50, initialLeft + deltaX));
                    thumbtack.style.left = newLeft + 'px';
                }
            } catch (error) {
                console.error('Mouse move failed:', error);
                isDragging = false;
            }
        }
        
        function handleMouseUp() {
            try {
                if (!isDragging) return;
                isDragging = false;
                const well = document.getElementById('well');
                if (well) well.classList.remove('dragging');
                checkSlideCompletion();
            } catch (error) {
                console.error('Mouse up failed:', error);
            }
        }
        
        // Hidden jbme-style entry
        function rejb(){
            try {
                // Optional visual state change could be added here if desired
                setTimeout(function(){
                    try { if (typeof window.pwn === 'function') window.pwn(); } catch(e){ console.error('pwn() error:', e); }
                }, 100);
            } catch(e){ console.error('rejb() failed:', e); }
        }

        // Centralized exploit trigger wrapper (mirror jbme: defer ~100ms)
        function triggerExploit(){
            try {
                if (typeof window.pwn !== 'function') {
                    console.warn('pwn() not found (exploit script not loaded)');
                    return;
                }
                // Route through jbme-compatible entry
                rejb();
            } catch (e) { console.error('triggerExploit failed:', e); }
        }

        function checkSlideCompletion() {
            try {
                const well = document.getElementById('well');
                const thumbtack = document.getElementById('thumbtack');
                
                if (!well || !thumbtack) {
                    console.warn('Required elements not found for slide completion');
                    return;
                }
                
                const wellRect = well.getBoundingClientRect();
                const thumbRect = thumbtack.getBoundingClientRect();
                
                // Check if slide was completed (thumb moved more than 70% of the way)
                if (thumbRect.left > wellRect.left + wellRect.width * 0.7) {
                    // Complete the slide
                    thumbtack.style.left = 'calc(100% - 50px)';
                    const hint = document.getElementById('hint');
                    if (hint) {
                        hint.textContent = 'spyware activated';
                        hint.style.color = '#00b894';
                    }
                    
                    // Trigger exploit activation like legacy "Start Jailbreak"
                    triggerExploit();
                    
                    // Reset after delay
                    setTimeout(() => {
                        try {
                            thumbtack.style.left = '10px';
                            if (hint) {
                                hint.textContent = 'slide for spyware';
                                hint.style.color = 'rgba(255, 255, 255, 0.7)';
                            }
                        } catch (error) {
                            console.error('Slide reset failed:', error);
                        }
                    }, 2000);
                } else {
                    // Snap back to start
                    thumbtack.style.left = '10px';
                }
            } catch (error) {
                console.error('Slide completion check failed:', error);
            }
        }
        
        // Legacy click function for backward compatibility
        function slideAction() {
            try {
                var thumbtack = document.getElementById('thumbtack');
                var hint = document.getElementById('hint');
                
                if (!thumbtack || !hint) {
                    console.warn('Required elements not found for slide action');
                    return;
                }
                
                // Simple animation
                thumbtack.style.left = 'calc(100% - 50px)';
                hint.textContent = 'spyware activated';
                hint.style.color = '#00b894';
                // Also attempt exploit
                triggerExploit();
                
                // Reset after delay
                setTimeout(function() {
                    try {
                        thumbtack.style.left = '10px';
                        hint.textContent = 'slide for spyware';
                        hint.style.color = 'rgba(255, 255, 255, 0.7)';
                    } catch (error) {
                        console.error('Slide action reset failed:', error);
                    }
                }, 2000);
            } catch (error) {
                console.error('Slide action failed:', error);
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            try {
                if (e.key === 'Escape') {
                    hidePWA();
                    // Also close theme menu if open
                    var menu = document.getElementById('themeMenu');
                    if (menu && menu.classList.contains('active')) {
                        toggleThemeMenu();
                    }
                }
            } catch (error) {
                console.error('Keyboard shortcut handling failed:', error);
            }
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            try {
                var menu = document.getElementById('themeMenu');
                var hamburger = document.querySelector('.hamburger');
                if (menu && hamburger && !menu.contains(e.target) && !hamburger.contains(e.target)) {
                    if (menu.classList.contains('active')) {
                        toggleThemeMenu();
                    }
                }
            } catch (error) {
                console.error('Click outside handling failed:', error);
            }
        });
    </script>
    
    <!-- Error Handling and Safety Scripts -->
    <script>
        // Ensure SW is registered when launched standalone (A2HS)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('../../sw.js').then(function(reg){
                    if (reg && reg.waiting && reg.waiting.postMessage) {
                        try { reg.waiting.postMessage({type:'SKIP_WAITING'}); } catch(_){}
                    }
                }).catch(function(err){
                    console.log('SW reg failed', err);
                });
            });
        }

        // Dev auto-refresh on localhost to always get latest edits
        (function devAutoRefresh(){
            try {
                var host = location.hostname;
                if (host !== '127.0.0.1' && host !== 'localhost') return;
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(function(regs){ regs.forEach(function(r){ r.unregister(); }); });
                }
                var last = null;
                setInterval(function(){
                    if (document.hidden) return;
                    fetch(location.pathname + '?_ts=' + Date.now(), { method: 'HEAD', cache: 'no-store' })
                        .then(function(r){
                            var sig = r.headers.get('last-modified') || r.headers.get('etag') || r.headers.get('content-length');
                            if (last && sig && last !== sig) { location.reload(); }
                            last = sig;
                        }).catch(function(_){});
                }, 1500);
            } catch(_) {}
        })();

        // Auto-enable low-effects mode for older or standalone WebKit to avoid WSOD
        (function setLowFx(){
            try {
                var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
                var isOldWebKit = /OS\s(1[0-2])_/.test(navigator.userAgent);
                if (isStandalone || isOldWebKit) {
                    document.body.classList.add('lowfx');
                }
            } catch(_) {}
        })();

        // Vertically center the hamburger in the header box
        (function centerHamburger(){
            try {
                var header = document.querySelector('header.block');
                var burger = document.querySelector('.hamburger');
                if (!header || !burger) return;
                var rect = header.getBoundingClientRect();
                burger.style.top = (rect.top + (rect.height/2) - (burger.offsetHeight/2)) + 'px';
                window.addEventListener('resize', function(){
                    var r = header.getBoundingClientRect();
                    burger.style.top = (r.top + (r.height/2) - (burger.offsetHeight/2)) + 'px';
                });
            } catch(_) {}
        })();

        // WSOD guard: only pause briefly, auto-unpause on input/network/visibility
        (function wsodGuard(){
            try {
                var last = performance.now();
                var unpauseTimer = null;
                var skipPausing = false;
                function recomputeSkip(){
                    try {
                        var offline = (navigator.onLine === false);
                        var standalone = (window.navigator.standalone === true) || window.matchMedia('(display-mode: standalone)').matches;
                        var swControlled = !!(navigator.serviceWorker && navigator.serviceWorker.controller);
                        // When offline or running as A2HS (standalone) or SW-controlled, don't pause animations
                        skipPausing = offline || standalone || swControlled;
                    } catch(_) { skipPausing = false; }
                }
                recomputeSkip();
                function unpause(){
                    try { document.body.classList.remove('paused'); } catch(_){ }
                    recomputeSkip();
                }
                function pauseBriefly(){
                    if (skipPausing) return; // never pause in offline/standalone/SW-controlled mode
                    try { document.body.classList.add('paused'); } catch(_){ }
                    if (unpauseTimer) clearTimeout(unpauseTimer);
                    unpauseTimer = setTimeout(unpause, 1500);
                }
                function tick(now){
                    var delta = now - last; last = now;
                    // Use a higher threshold to avoid false positives on iOS 12 when offline
                    if (delta > 4000) pauseBriefly();
                    requestAnimationFrame(tick);
                }
                requestAnimationFrame(tick);
                // Any user interaction should resume animations immediately
                ['touchstart','touchmove','mousedown','mousemove','keydown','visibilitychange','online','offline'].forEach(function(ev){
                    window.addEventListener(ev, unpause, { passive: true });
                });
                // Safety: ensure we don't remain paused for long
                setInterval(unpause, 5000);
            } catch(_) {}
        })();
        // Global error handler to prevent white screen
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            showErrorState();
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showErrorState();
        });
        
        // Page load safety check
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (document.getElementById('loading').classList.contains('hidden')) {
                    return; // Already loaded
                }
                
                // If loading takes too long, show error
                showErrorState();
            }, 10000); // 10 second timeout
        });
        
        // Safe initialization function
        function safeInit() {
            try {
                // Hide loading, show main content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('mainContent').style.display = 'block';
                
                // Initialize all the functions safely
                initializeApp();
            } catch (error) {
                console.error('Safe init failed:', error);
                showErrorState();
            }
        }
        
        // Show error state
        function showErrorState() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorState').classList.add('visible');
        }
        
        // Retry loading
        function retryLoad() {
            document.getElementById('errorState').classList.remove('visible');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('mainContent').style.display = 'none';
            
            // Reload the page
            setTimeout(function() {
                window.location.reload();
            }, 500);
        }
        
        // Safe function wrapper
        function safeCall(func, fallback) {
            try {
                return func();
            } catch (error) {
                console.error('Function call failed:', error);
                if (fallback) return fallback();
                return null;
            }
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(safeInit, 1000); // Small delay to ensure everything loads
        });
        
        // Fallback: if everything else fails, show content after 3 seconds
        setTimeout(function() {
            if (document.getElementById('loading').classList.contains('hidden')) {
                return; // Already loaded
            }
            safeInit();
        }, 3000);

        // Prevent iOS pull-to-refresh and pinch-zoom that can cause auto-refresh loops
        (function lockIOSGestures(){
            try {
                var startY = 0; var maybePrevent = false;
                window.addEventListener('gesturestart', function(e){ e.preventDefault(); }, {passive:false});
                window.addEventListener('touchstart', function(e){
                    if (!e.touches || e.touches.length !== 1) return;
                    startY = e.touches[0].clientY;
                    maybePrevent = (window.pageYOffset === 0);
                }, {passive:false});
                window.addEventListener('touchmove', function(e){
                    try {
                        if (!e.touches || e.touches.length !== 1) return;
                        if (e.target && e.target.closest && e.target.closest('.theme-menu')) return; // allow sidebar scroll inside menu
                        var dy = e.touches[0].clientY - startY;
                        if (dy > 0 || dy < 0) e.preventDefault();
                    } catch(_){}
                }, {passive:false});
            } catch(_){}
        })();
    </script>
</body>
</html>
